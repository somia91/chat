<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>💬 ChatApp - غرفة المحادثة</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: #f3f4f6;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: white;
            padding: 16px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .main-content {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        .video-area {
            width: 33%;
            background: black;
            position: relative;
            display: none;
        }

        .video-area.active {
            display: block;
        }

        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .messages {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        .message {
            margin-bottom: 16px;
            display: flex;
        }

        .message.own {
            justify-content: flex-end;
        }

        .message-bubble {
            max-width: 300px;
            padding: 12px 16px;
            border-radius: 12px;
            word-wrap: break-word;
        }

        .message-bubble.system {
            background: #e5e7eb;
            color: #374151;
            text-align: center;
        }

        .message-bubble.own {
            background: #4f46e5;
            color: white;
        }

        .message-bubble.other {
            background: white;
            color: #1f2937;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .message-user {
            font-size: 12px;
            opacity: 0.75;
            margin-bottom: 4px;
        }

        .message-time {
            font-size: 12px;
            opacity: 0.75;
            margin-top: 4px;
        }

        .call-controls {
            padding: 16px;
            background: white;
            border-top: 1px solid #e5e7eb;
            display: flex;
            gap: 8px;
            justify-content: center;
        }

        .message-input {
            padding: 16px;
            background: white;
            border-top: 1px solid #e5e7eb;
            display: flex;
            gap: 8px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: #4f46e5;
            color: white;
        }

        .btn-primary:hover {
            background: #4338ca;
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
            border-radius: 50%;
            width: 50px;
            height: 50px;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 16px;
        }

        .input:focus {
            outline: none;
            border-color: #4f46e5;
        }

        .video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .local-video {
            position: absolute;
            top: 16px;
            right: 16px;
            width: 128px;
            height: 96px;
            border: 2px solid white;
            border-radius: 8px;
        }

        .audio-call-display {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: white;
            text-align: center;
        }

        .end-call-btn {
            position: absolute;
            bottom: 16px;
            left: 50%;
            transform: translateX(-50%);
        }

        .text-xl {
            font-size: 1.25rem;
        }

        .font-bold {
            font-weight: 700;
        }

        .text-gray-600 {
            color: #6b7280;
        }

        .text-gray-800 {
            color: #1f2937;
        }

        /* Call notification styles */
        .call-notification {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            padding: 30px;
            text-align: center;
            z-index: 1000;
            min-width: 300px;
            border: 3px solid #10b981;
            animation: pulse 2s infinite;
        }

        .call-notification.hidden {
            display: none;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(16, 185, 129, 0); }
            100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
        }

        .call-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }

        .accept-btn {
            background: #10b981;
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 50px;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .accept-btn:hover {
            background: #059669;
            transform: scale(1.1);
        }

        .reject-btn {
            background: #ef4444;
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 50px;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .reject-btn:hover {
            background: #dc2626;
            transform: scale(1.1);
        }

        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 999;
        }

        .overlay.hidden {
            display: none;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div>
            <h1 class="text-xl font-bold text-gray-800">غرفة: <span id="roomIdDisplay"></span></h1>
            <p class="text-gray-600">متصل: <span id="userCount">1</span> مستخدم</p>
        </div>
        <div style="display: flex; gap: 8px;">
            <button onclick="copyRoomLink()" class="btn btn-primary" style="padding: 8px 16px; font-size: 14px;">
                📋 نسخ الرابط
            </button>
            <button onclick="shareRoom()" class="btn btn-success" style="padding: 8px 16px; font-size: 14px;">
                📤 مشاركة
            </button>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Video Call Area -->
        <div id="videoArea" class="video-area">
            <video id="localVideo" class="video" autoplay muted></video>
            <video id="remoteVideo" class="local-video" autoplay></video>
            
            <div id="audioCallDisplay" class="audio-call-display" style="display: none;">
                <div>
                    <div style="font-size: 4rem; margin-bottom: 16px;">🎤</div>
                    <p>مكالمة صوتية نشطة</p>
                </div>
            </div>
            
            <div class="end-call-btn">
                <button onclick="endCall()" class="btn btn-danger">📞</button>
            </div>
        </div>

        <!-- Chat Area -->
        <div class="chat-area">
            <!-- Messages -->
            <div id="messages" class="messages"></div>

            <!-- Call Controls -->
            <div id="callControls" class="call-controls">
                <button onclick="startVideoCall()" class="btn btn-success">📹 مكالمة مرئية</button>
                <button onclick="startAudioCall()" class="btn btn-primary">📞 مكالمة صوتية</button>
                <button onclick="testIncomingCall()" class="btn btn-primary" style="background: #f59e0b; font-size: 12px;">
                    🧪 اختبار مكالمة واردة
                </button>
            </div>

            <!-- Message Input -->
            <div class="message-input">
                <input
                    type="text"
                    id="messageInput"
                    placeholder="اكتب رسالتك..."
                    class="input"
                    onkeypress="handleKeyPress(event)"
                />
                <button onclick="sendMessage()" class="btn btn-primary">إرسال</button>
            </div>
        </div>
    </div>

    <!-- Call Notification Overlay -->
    <div id="callOverlay" class="overlay hidden"></div>
    <div id="callNotification" class="call-notification hidden">
        <div style="font-size: 3rem; margin-bottom: 15px;">📞</div>
        <h3 style="margin-bottom: 10px; color: #1f2937;">مكالمة واردة</h3>
        <p id="callerName" style="font-size: 18px; color: #6b7280; margin-bottom: 20px;">من: مجهول</p>
        <p id="callType" style="font-size: 16px; color: #10b981; margin-bottom: 20px;">مكالمة صوتية</p>

        <div class="call-buttons">
            <button onclick="acceptCall()" class="accept-btn">
                ✅ قبول
            </button>
            <button onclick="rejectCall()" class="reject-btn">
                ❌ رفض
            </button>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, set, push, onValue, off, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        // Firebase configuration - استبدل بإعداداتك
        const firebaseConfig = {
            apiKey: "AIzaSyDemo-Replace-With-Your-Key",
            authDomain: "chatapp-demo.firebaseapp.com",
            databaseURL: "https://chatapp-demo-default-rtdb.firebaseio.com",
            projectId: "chatapp-demo",
            storageBucket: "chatapp-demo.appspot.com",
            messagingSenderId: "123456789",
            appId: "1:123456789:web:abcdef123456"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        // Make Firebase available globally
        window.firebaseApp = app;
        window.firebaseDatabase = database;
        window.firebaseRef = ref;
        window.firebaseSet = set;
        window.firebasePush = push;
        window.firebaseOnValue = onValue;
        window.firebaseOff = off;
        window.firebaseServerTimestamp = serverTimestamp;
    </script>

    <script>
        // Get URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const roomId = urlParams.get('roomId');
        const userParam = urlParams.get('user');
        const isCreator = urlParams.get('creator') === 'true';

        // Parse user info
        let currentUserInfo = null;
        let userName = 'مجهول';

        if (userParam) {
            try {
                currentUserInfo = JSON.parse(decodeURIComponent(userParam));
                userName = currentUserInfo.name || 'مجهول';
            } catch (error) {
                console.error('Error parsing user info:', error);
            }
        }

        // Fallback to URL name parameter
        if (!currentUserInfo) {
            userName = urlParams.get('name') || 'مجهول';
            currentUserInfo = {
                name: userName,
                verified: false,
                isSignedIn: false
            };
        }

        // Global variables
        let messages = [];
        let isVideoCall = false;
        let isAudioCall = false;
        let localStream = null;
        let incomingCall = null;
        let callSound = null;
        let connectedUsers = [userName];
        let firebaseInitialized = false;
        let messagesListener = null;
        let callsListener = null;
        let usersListener = null;
        let currentUserInfo = null;

        // Initialize Firebase when available
        function initializeFirebase() {
            if (window.firebaseDatabase && !firebaseInitialized) {
                firebaseInitialized = true;
                console.log('🔥 Firebase initialized successfully');

                // Set up real-time listeners
                setupMessageListener();
                setupCallListener();
                setupUserPresence();

                // Add user to room
                addUserToRoom();
            } else {
                console.log('⚠️ Firebase not available, using local mode');
            }
        }

        // Wait for Firebase to load
        setTimeout(initializeFirebase, 1000);

        // Firebase functions for real-time sync
        function setupMessageListener() {
            if (!window.firebaseDatabase) return;

            const messagesRef = window.firebaseRef(window.firebaseDatabase, `rooms/${roomId}/messages`);
            messagesListener = window.firebaseOnValue(messagesRef, (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    // Clear local messages and load from Firebase
                    messages = [];
                    Object.keys(data).forEach(key => {
                        const message = data[key];
                        messages.push({
                            id: key,
                            user: message.user,
                            text: message.text,
                            timestamp: new Date(message.timestamp),
                            type: message.type || 'text'
                        });
                    });

                    // Sort by timestamp
                    messages.sort((a, b) => a.timestamp - b.timestamp);
                    renderMessages();
                    scrollToBottom();
                }
            });
        }

        function setupCallListener() {
            if (!window.firebaseDatabase) return;

            const callsRef = window.firebaseRef(window.firebaseDatabase, `rooms/${roomId}/calls`);
            callsListener = window.firebaseOnValue(callsRef, (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    Object.keys(data).forEach(key => {
                        const call = data[key];
                        // Only show notification if it's for this user and not from this user
                        if (call.target === userName && call.caller !== userName && !incomingCall) {
                            showCallNotification(call.caller, call.type);

                            // Remove the call notification after showing
                            setTimeout(() => {
                                const callRef = window.firebaseRef(window.firebaseDatabase, `rooms/${roomId}/calls/${key}`);
                                window.firebaseSet(callRef, null);
                            }, 1000);
                        }
                    });
                }
            });
        }

        function setupUserPresence() {
            if (!window.firebaseDatabase) return;

            const usersRef = window.firebaseRef(window.firebaseDatabase, `rooms/${roomId}/users`);
            usersListener = window.firebaseOnValue(usersRef, (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    connectedUsers = Object.values(data).map(user => user.name);
                    updateUserCount();
                }
            });
        }

        function addUserToRoom() {
            if (!window.firebaseDatabase) return;

            const userRef = window.firebaseRef(window.firebaseDatabase, `rooms/${roomId}/users/${userName}`);
            window.firebaseSet(userRef, {
                name: userName,
                phone: currentUserInfo.phone || null,
                verified: currentUserInfo.verified || false,
                isSignedIn: currentUserInfo.isSignedIn || false,
                joinedAt: window.firebaseServerTimestamp(),
                online: true
            });
        }

        function sendMessageToFirebase(user, text, type = 'text') {
            if (!window.firebaseDatabase) {
                // Fallback to local storage
                addMessage(user, text, type);
                return;
            }

            const messagesRef = window.firebaseRef(window.firebaseDatabase, `rooms/${roomId}/messages`);
            window.firebasePush(messagesRef, {
                user: user,
                text: text,
                type: type,
                timestamp: Date.now()
            });
        }

        function sendCallNotification(targetUser, callType) {
            if (!window.firebaseDatabase) return;

            const callsRef = window.firebaseRef(window.firebaseDatabase, `rooms/${roomId}/calls`);
            window.firebasePush(callsRef, {
                caller: userName,
                target: targetUser,
                type: callType,
                timestamp: Date.now()
            });
        }

        // Initialize
        document.getElementById('roomIdDisplay').textContent = roomId;

        // Add welcome message
        setTimeout(() => {
            sendMessageToFirebase('النظام', `مرحباً ${userName}! انضممت للغرفة ${roomId}`, 'system');
        }, 1500);

        function addMessage(user, text, type = 'text') {
            const message = {
                id: Date.now(),
                user: user,
                text: text,
                timestamp: new Date(),
                type: type
            };
            
            messages.push(message);
            renderMessages();
            scrollToBottom();
        }

        function renderMessages() {
            const messagesContainer = document.getElementById('messages');
            messagesContainer.innerHTML = '';
            
            messages.forEach(message => {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${message.user === userName ? 'own' : ''}`;
                
                const bubbleDiv = document.createElement('div');
                bubbleDiv.className = `message-bubble ${
                    message.type === 'system' ? 'system' : 
                    message.user === userName ? 'own' : 'other'
                }`;
                
                let content = '';
                if (message.type !== 'system') {
                    content += `<div class="message-user">${message.user}</div>`;
                }
                content += `<div>${message.text}</div>`;
                content += `<div class="message-time">${message.timestamp.toLocaleTimeString('ar-SA')}</div>`;
                
                bubbleDiv.innerHTML = content;
                messageDiv.appendChild(bubbleDiv);
                messagesContainer.appendChild(messageDiv);
            });
        }

        function scrollToBottom() {
            const messagesContainer = document.getElementById('messages');
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function sendMessage() {
            const input = document.getElementById('messageInput');
            const text = input.value.trim();

            if (text) {
                // Send to Firebase for real-time sync
                sendMessageToFirebase(userName, text);
                input.value = '';
            }
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        // Call notification functions
        function showCallNotification(callerName, callType) {
            document.getElementById('callerName').textContent = `من: ${callerName}`;
            document.getElementById('callType').textContent = callType === 'video' ? '📹 مكالمة مرئية' : '📞 مكالمة صوتية';
            document.getElementById('callOverlay').classList.remove('hidden');
            document.getElementById('callNotification').classList.remove('hidden');

            // Play call sound
            playCallSound();

            // Store incoming call info
            incomingCall = { caller: callerName, type: callType };
        }

        function hideCallNotification() {
            document.getElementById('callOverlay').classList.add('hidden');
            document.getElementById('callNotification').classList.add('hidden');
            stopCallSound();
            incomingCall = null;
        }

        function playCallSound() {
            // Create audio context for call sound
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);

                oscillator.start();
                oscillator.stop(audioContext.currentTime + 0.5);

                // Repeat every 2 seconds
                callSound = setInterval(() => {
                    if (incomingCall) {
                        const newOscillator = audioContext.createOscillator();
                        const newGainNode = audioContext.createGain();

                        newOscillator.connect(newGainNode);
                        newGainNode.connect(audioContext.destination);

                        newOscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                        newGainNode.gain.setValueAtTime(0.3, audioContext.currentTime);

                        newOscillator.start();
                        newOscillator.stop(audioContext.currentTime + 0.5);
                    }
                }, 2000);
            } catch (error) {
                console.log('Could not play call sound:', error);
            }
        }

        function stopCallSound() {
            if (callSound) {
                clearInterval(callSound);
                callSound = null;
            }
        }

        function acceptCall() {
            if (!incomingCall) return;

            hideCallNotification();

            if (incomingCall.type === 'video') {
                startVideoCall(true); // true means accepting incoming call
            } else {
                startAudioCall(true); // true means accepting incoming call
            }

            addMessage('النظام', `قبلت مكالمة من ${incomingCall.caller}`, 'system');

            // Simulate notifying the caller that call was accepted
            simulateCallResponse('accepted');
        }

        function rejectCall() {
            if (!incomingCall) return;

            hideCallNotification();
            addMessage('النظام', `رفضت مكالمة من ${incomingCall.caller}`, 'system');

            // Simulate notifying the caller that call was rejected
            simulateCallResponse('rejected');
        }

        function simulateCallResponse(response) {
            // In a real app, this would send the response to the caller
            // For now, we'll just add a message
            if (response === 'accepted') {
                addMessage('النظام', 'تم قبول المكالمة - بدء الاتصال...', 'system');
            } else {
                addMessage('النظام', 'تم رفض المكالمة', 'system');
            }
        }

        async function startVideoCall(isAccepting = false) {
            try {
                localStream = await navigator.mediaDevices.getUserMedia({
                    video: true,
                    audio: true
                });

                document.getElementById('localVideo').srcObject = localStream;
                document.getElementById('videoArea').classList.add('active');
                document.getElementById('callControls').style.display = 'none';
                document.getElementById('audioCallDisplay').style.display = 'none';

                isVideoCall = true;
                isAudioCall = false;

                if (!isAccepting) {
                    sendMessageToFirebase('النظام', `${userName} بدأ مكالمة مرئية`, 'system');
                    // Send call notification to all users in room
                    notifyAllUsersOfCall('video');
                }
            } catch (error) {
                alert('لا يمكن الوصول للكاميرا والميكروفون');
            }
        }

        async function startAudioCall(isAccepting = false) {
            try {
                localStream = await navigator.mediaDevices.getUserMedia({
                    video: false,
                    audio: true
                });

                document.getElementById('videoArea').classList.add('active');
                document.getElementById('callControls').style.display = 'none';
                document.getElementById('audioCallDisplay').style.display = 'flex';

                isAudioCall = true;
                isVideoCall = false;

                if (!isAccepting) {
                    sendMessageToFirebase('النظام', `${userName} بدأ مكالمة صوتية`, 'system');
                    // Send call notification to all users in room
                    notifyAllUsersOfCall('audio');
                }
            } catch (error) {
                alert('لا يمكن الوصول للميكروفون');
            }
        }

        function notifyAllUsersOfCall(callType) {
            // Send call notification to all connected users except self
            connectedUsers.forEach(user => {
                if (user !== userName) {
                    sendCallNotification(user, callType);
                }
            });
        }

        // Add test button for incoming calls (for demo)
        function testIncomingCall() {
            if (!incomingCall) {
                showCallNotification('مستخدم تجريبي', 'video');
            }
        }

        function endCall() {
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            
            document.getElementById('videoArea').classList.remove('active');
            document.getElementById('callControls').style.display = 'flex';
            
            isVideoCall = false;
            isAudioCall = false;

            sendMessageToFirebase('النظام', `${userName} أنهى المكالمة`, 'system');
        }

        function copyRoomLink() {
            // Get the correct base URL for GitHub Pages
            const baseUrl = window.location.origin + window.location.pathname.replace('/room.html', '');
            const link = `${baseUrl}/room.html?roomId=${roomId}`;

            navigator.clipboard.writeText(link).then(() => {
                alert('✅ تم نسخ رابط الغرفة!\n\n' + link + '\n\nيمكنك الآن إرساله لأصدقائك');
            }).catch(() => {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = link;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert('✅ تم نسخ رابط الغرفة!\n\n' + link + '\n\nيمكنك الآن إرساله لأصدقائك');
            });
        }

        function shareRoom() {
            // Get the correct base URL for GitHub Pages
            const baseUrl = window.location.origin + window.location.pathname.replace('/room.html', '');
            const link = `${baseUrl}/room.html?roomId=${roomId}`;
            const shareText = `🎉 انضم إلي في ChatApp!\n\nغرفة: ${roomId}\nالرابط: ${link}\n\n💬 مراسلة فورية + مكالمات صوتية ومرئية`;

            // Try native sharing first (mobile)
            if (navigator.share) {
                navigator.share({
                    title: 'ChatApp - انضم للمحادثة',
                    text: shareText,
                    url: link
                }).catch(() => {
                    // Fallback to copy
                    copyToClipboard(shareText);
                });
            } else {
                // Desktop fallback
                copyToClipboard(shareText);
            }
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert('📤 تم نسخ رسالة المشاركة!\n\nيمكنك الآن لصقها في WhatsApp أو أي تطبيق آخر');
            }).catch(() => {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert('📤 تم نسخ رسالة المشاركة!\n\nيمكنك الآن لصقها في WhatsApp أو أي تطبيق آخر');
            });
        }

        // Redirect to home if no room ID
        if (!roomId) {
            window.location.href = 'index.html';
        }
    </script>
</body>
</html>

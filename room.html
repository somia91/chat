<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>💬 ChatApp - غرفة المحادثة</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: #f3f4f6;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: white;
            padding: 16px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .main-content {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        .video-area {
            width: 33%;
            background: black;
            position: relative;
            display: none;
        }

        .video-area.active {
            display: block;
        }

        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .messages {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        .message {
            margin-bottom: 16px;
            display: flex;
        }

        .message.own {
            justify-content: flex-end;
        }

        .message-bubble {
            max-width: 300px;
            padding: 12px 16px;
            border-radius: 12px;
            word-wrap: break-word;
        }

        .message-bubble.system {
            background: #e5e7eb;
            color: #374151;
            text-align: center;
        }

        .message-bubble.own {
            background: #4f46e5;
            color: white;
        }

        .message-bubble.other {
            background: white;
            color: #1f2937;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .message-user {
            font-size: 12px;
            opacity: 0.75;
            margin-bottom: 4px;
        }

        .message-time {
            font-size: 12px;
            opacity: 0.75;
            margin-top: 4px;
        }

        .call-controls {
            padding: 16px;
            background: white;
            border-top: 1px solid #e5e7eb;
            display: flex;
            gap: 8px;
            justify-content: center;
        }

        .message-input {
            padding: 16px;
            background: white;
            border-top: 1px solid #e5e7eb;
            display: flex;
            gap: 8px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: #4f46e5;
            color: white;
        }

        .btn-primary:hover {
            background: #4338ca;
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
            border-radius: 50%;
            width: 50px;
            height: 50px;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 16px;
        }

        .input:focus {
            outline: none;
            border-color: #4f46e5;
        }

        .video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .local-video {
            position: absolute;
            top: 16px;
            right: 16px;
            width: 128px;
            height: 96px;
            border: 2px solid white;
            border-radius: 8px;
        }

        .audio-call-display {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: white;
            text-align: center;
        }

        .end-call-btn {
            position: absolute;
            bottom: 16px;
            left: 50%;
            transform: translateX(-50%);
        }

        .text-xl {
            font-size: 1.25rem;
        }

        .font-bold {
            font-weight: 700;
        }

        .text-gray-600 {
            color: #6b7280;
        }

        .text-gray-800 {
            color: #1f2937;
        }

        /* Call notification styles */
        .call-notification {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            padding: 30px;
            text-align: center;
            z-index: 1000;
            min-width: 300px;
            border: 3px solid #10b981;
            animation: pulse 2s infinite;
        }

        .call-notification.hidden {
            display: none;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(16, 185, 129, 0); }
            100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
        }

        .call-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }

        .accept-btn {
            background: #10b981;
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 50px;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .accept-btn:hover {
            background: #059669;
            transform: scale(1.1);
        }

        .reject-btn {
            background: #ef4444;
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 50px;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .reject-btn:hover {
            background: #dc2626;
            transform: scale(1.1);
        }

        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 999;
        }

        .overlay.hidden {
            display: none;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div>
            <h1 class="text-xl font-bold text-gray-800">غرفة: <span id="roomIdDisplay"></span></h1>
            <div style="display: flex; align-items: center; gap: 10px;">
                <p class="text-gray-600">متصل: <span id="userCount">1</span> مستخدم</p>
                <div id="connectionStatus" style="display: flex; align-items: center; gap: 5px; font-size: 12px;">
                    <span id="connectionDot" style="width: 8px; height: 8px; border-radius: 50%; background: #ef4444;"></span>
                    <span id="connectionText" style="color: #6b7280;">محلي</span>
                </div>
            </div>
        </div>
        <div style="display: flex; gap: 8px;">
            <button onclick="copyRoomLink()" class="btn btn-primary" style="padding: 8px 16px; font-size: 14px;">
                📋 نسخ الرابط
            </button>
            <button onclick="shareRoom()" class="btn btn-success" style="padding: 8px 16px; font-size: 14px;">
                📤 مشاركة
            </button>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Video Call Area -->
        <div id="videoArea" class="video-area">
            <video id="remoteVideo" class="video" autoplay></video>
            <video id="localVideo" class="local-video" autoplay muted></video>
            
            <div id="audioCallDisplay" class="audio-call-display" style="display: none;">
                <div>
                    <div style="font-size: 4rem; margin-bottom: 16px;">🎤</div>
                    <p>مكالمة صوتية نشطة</p>
                </div>
            </div>
            
            <div class="end-call-btn" style="display: flex; gap: 10px; justify-content: center;">
                <button onclick="toggleMute()" id="muteBtn" class="btn" style="background: #6b7280; color: white; padding: 8px 12px; font-size: 14px;">🔇 كتم</button>
                <button onclick="toggleVideo()" id="videoBtn" class="btn" style="background: #6b7280; color: white; padding: 8px 12px; font-size: 14px;">📹 فيديو</button>
                <button onclick="endCall()" class="btn btn-danger">📞</button>
            </div>
        </div>

        <!-- Chat Area -->
        <div class="chat-area">
            <!-- Messages -->
            <div id="messages" class="messages"></div>

            <!-- Typing Indicator -->
            <div id="typingIndicator" style="display: none; padding: 10px; font-size: 14px; color: #6b7280; font-style: italic;">
                <span id="typingText">أحمد يكتب...</span>
            </div>

            <!-- Call Controls -->
            <div id="callControls" class="call-controls">
                <button onclick="startVideoCall()" class="btn btn-success">📹 مكالمة مرئية</button>
                <button onclick="startAudioCall()" class="btn btn-primary">📞 مكالمة صوتية</button>
                <button onclick="testIncomingCall()" class="btn btn-primary" style="background: #f59e0b; font-size: 12px;">
                    🧪 اختبار مكالمة واردة
                </button>
            </div>

            <!-- Message Input -->
            <div class="message-input">
                <input
                    type="text"
                    id="messageInput"
                    placeholder="اكتب رسالتك..."
                    class="input"
                    onkeypress="handleKeyPress(event)"
                    oninput="handleTyping()"
                />
                <button onclick="sendMessage()" class="btn btn-primary">إرسال</button>
            </div>
        </div>
    </div>

    <!-- Call Notification Overlay -->
    <div id="callOverlay" class="overlay hidden"></div>
    <div id="callNotification" class="call-notification hidden">
        <div style="font-size: 3rem; margin-bottom: 15px;">📞</div>
        <h3 style="margin-bottom: 10px; color: #1f2937;">مكالمة واردة</h3>
        <p id="callerName" style="font-size: 18px; color: #6b7280; margin-bottom: 20px;">من: مجهول</p>
        <p id="callType" style="font-size: 16px; color: #10b981; margin-bottom: 20px;">مكالمة صوتية</p>

        <div class="call-buttons">
            <button onclick="acceptCall()" class="accept-btn">
                ✅ قبول
            </button>
            <button onclick="rejectCall()" class="reject-btn">
                ❌ رفض
            </button>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, set, push, onValue, off, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        // Firebase configuration - استبدل بإعداداتك الحقيقية
        const firebaseConfig = {
            apiKey: "AIzaSyDemo-Replace-With-Your-Key",
            authDomain: "chatapp-demo.firebaseapp.com",
            databaseURL: "https://chatapp-demo-default-rtdb.firebaseio.com",
            projectId: "chatapp-demo",
            storageBucket: "chatapp-demo.appspot.com",
            messagingSenderId: "123456789",
            appId: "1:123456789:web:abcdef123456"
        };

        // Firebase connection status
        let firebaseConnected = false;
        let connectionStatusElement = null;

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        // Make Firebase available globally
        window.firebaseApp = app;
        window.firebaseDatabase = database;
        window.firebaseRef = ref;
        window.firebaseSet = set;
        window.firebasePush = push;
        window.firebaseOnValue = onValue;
        window.firebaseOff = off;
        window.firebaseServerTimestamp = serverTimestamp;
    </script>

    <script>
        // Get URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const roomId = urlParams.get('roomId');
        const userParam = urlParams.get('user');
        const isCreator = urlParams.get('creator') === 'true';

        // Parse user info
        let currentUserInfo = null;
        let userName = 'مجهول';

        if (userParam) {
            try {
                currentUserInfo = JSON.parse(decodeURIComponent(userParam));
                userName = currentUserInfo.name || 'مجهول';
            } catch (error) {
                console.error('Error parsing user info:', error);
            }
        }

        // Fallback to URL name parameter
        if (!currentUserInfo) {
            userName = urlParams.get('name') || 'مجهول';
            currentUserInfo = {
                name: userName,
                verified: false,
                isSignedIn: false
            };
        }

        // Global variables
        let messages = [];
        let isVideoCall = false;
        let isAudioCall = false;
        let localStream = null;
        let remoteStream = null;
        let incomingCall = null;
        let callSound = null;
        let connectedUsers = [userName];
        let firebaseInitialized = false;
        let messagesListener = null;
        let callsListener = null;
        let usersListener = null;

        // WebRTC variables
        let peerConnection = null;
        let currentCallId = null;
        let isCallInitiator = false;
        let callState = 'idle'; // idle, calling, ringing, connected

        // WebRTC configuration
        const rtcConfiguration = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' },
                { urls: 'stun:stun2.l.google.com:19302' }
            ]
        };

        // Initialize Firebase when available
        function initializeFirebase() {
            if (window.firebaseDatabase && !firebaseInitialized) {
                firebaseInitialized = true;
                firebaseConnected = true;
                console.log('🔥 Firebase initialized successfully');

                // Update connection status
                updateConnectionStatus(true);

                // Set up real-time listeners
                setupMessageListener();
                setupCallListener();
                setupUserPresence();
                setupTypingListener();
                setupWebRTCSignaling();

                // Add user to room
                addUserToRoom();

                // Monitor connection status
                monitorFirebaseConnection();
            } else {
                console.log('⚠️ Firebase not available, using local mode');
                updateConnectionStatus(false);
            }
        }

        // Monitor Firebase connection
        function monitorFirebaseConnection() {
            if (!window.firebaseDatabase) return;

            const connectedRef = window.firebaseRef(window.firebaseDatabase, '.info/connected');
            window.firebaseOnValue(connectedRef, (snapshot) => {
                const connected = snapshot.val();
                firebaseConnected = connected;
                updateConnectionStatus(connected);

                if (connected) {
                    console.log('🔥 Firebase connected');
                    // Re-add user to room when reconnected
                    addUserToRoom();
                } else {
                    console.log('❌ Firebase disconnected');
                }
            });
        }

        // Update connection status indicator
        function updateConnectionStatus(connected) {
            const dot = document.getElementById('connectionDot');
            const text = document.getElementById('connectionText');

            if (connected) {
                dot.style.background = '#10b981'; // Green
                text.textContent = 'متصل';
                text.style.color = '#10b981';
            } else {
                dot.style.background = '#ef4444'; // Red
                text.textContent = 'محلي';
                text.style.color = '#6b7280';
            }
        }

        // Wait for Firebase to load
        setTimeout(initializeFirebase, 1000);

        // Firebase functions for real-time sync
        function setupMessageListener() {
            if (!window.firebaseDatabase) return;

            const messagesRef = window.firebaseRef(window.firebaseDatabase, `rooms/${roomId}/messages`);
            messagesListener = window.firebaseOnValue(messagesRef, (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    const previousMessageCount = messages.length;

                    // Clear local messages and load from Firebase
                    messages = [];
                    Object.keys(data).forEach(key => {
                        const message = data[key];
                        messages.push({
                            id: key,
                            user: message.user,
                            text: message.text,
                            timestamp: new Date(message.timestamp),
                            type: message.type || 'text'
                        });
                    });

                    // Sort by timestamp
                    messages.sort((a, b) => a.timestamp - b.timestamp);
                    renderMessages();
                    scrollToBottom();

                    // Play notification sound for new messages (not from current user)
                    if (messages.length > previousMessageCount) {
                        const latestMessage = messages[messages.length - 1];
                        if (latestMessage.user !== userName && latestMessage.type !== 'system') {
                            playMessageSound();
                        }
                    }
                }
            });
        }

        function setupCallListener() {
            if (!window.firebaseDatabase) return;

            const callsRef = window.firebaseRef(window.firebaseDatabase, `rooms/${roomId}/calls`);
            callsListener = window.firebaseOnValue(callsRef, (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    Object.keys(data).forEach(key => {
                        const call = data[key];
                        // Only show notification if it's for this user and not from this user
                        if (call.target === userName && call.caller !== userName && !incomingCall) {
                            showCallNotification(call.caller, call.type);

                            // Remove the call notification after showing
                            setTimeout(() => {
                                const callRef = window.firebaseRef(window.firebaseDatabase, `rooms/${roomId}/calls/${key}`);
                                window.firebaseSet(callRef, null);
                            }, 1000);
                        }
                    });
                }
            });
        }

        function setupUserPresence() {
            if (!window.firebaseDatabase) return;

            const usersRef = window.firebaseRef(window.firebaseDatabase, `rooms/${roomId}/users`);
            usersListener = window.firebaseOnValue(usersRef, (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    connectedUsers = Object.values(data).map(user => user.name);
                    updateUserCount();
                }
            });
        }

        function setupTypingListener() {
            if (!window.firebaseDatabase) return;

            const typingRef = window.firebaseRef(window.firebaseDatabase, `rooms/${roomId}/typing`);
            window.firebaseOnValue(typingRef, (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    // Find users who are typing (excluding current user)
                    const typingUsers = Object.keys(data).filter(user =>
                        user !== userName &&
                        data[user] === true
                    );

                    showTypingIndicator(typingUsers);
                } else {
                    hideTypingIndicator();
                }
            });
        }

        function setupWebRTCSignaling() {
            if (!window.firebaseDatabase) return;

            // Listen for WebRTC signaling messages
            const signalingRef = window.firebaseRef(window.firebaseDatabase, `rooms/${roomId}/webrtc`);
            window.firebaseOnValue(signalingRef, (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    Object.keys(data).forEach(async (key) => {
                        const signal = data[key];

                        // Only process signals meant for this user
                        if (signal.target === userName && signal.sender !== userName) {
                            await handleWebRTCSignal(signal);

                            // Remove processed signal
                            const signalRef = window.firebaseRef(window.firebaseDatabase, `rooms/${roomId}/webrtc/${key}`);
                            window.firebaseSet(signalRef, null);
                        }
                    });
                }
            });
        }

        function updateUserCount() {
            const userCountElement = document.getElementById('userCount');
            if (userCountElement) {
                userCountElement.textContent = connectedUsers.length;
            }
        }

        function addUserToRoom() {
            if (!window.firebaseDatabase) return;

            const userRef = window.firebaseRef(window.firebaseDatabase, `rooms/${roomId}/users/${userName}`);
            window.firebaseSet(userRef, {
                name: userName,
                phone: currentUserInfo.phone || null,
                verified: currentUserInfo.verified || false,
                isSignedIn: currentUserInfo.isSignedIn || false,
                joinedAt: window.firebaseServerTimestamp(),
                online: true
            });
        }

        function sendMessageToFirebase(user, text, type = 'text') {
            if (!window.firebaseDatabase) {
                // Fallback to localStorage sync
                addMessageToLocalSync(user, text, type);
                return;
            }

            const messagesRef = window.firebaseRef(window.firebaseDatabase, `rooms/${roomId}/messages`);
            window.firebasePush(messagesRef, {
                user: user,
                text: text,
                type: type,
                timestamp: Date.now()
            });
        }

        // Local sync system (temporary solution)
        function addMessageToLocalSync(user, text, type = 'text') {
            const message = {
                id: Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                user: user,
                text: text,
                timestamp: Date.now(),
                type: type,
                roomId: roomId
            };

            // Add to local messages
            addMessage(user, text, type);

            // Save to localStorage for sync
            saveMessageToLocalStorage(message);

            // Trigger sync event
            triggerSyncEvent(message);
        }

        function saveMessageToLocalStorage(message) {
            const storageKey = `chatapp_room_${roomId}`;
            let roomMessages = JSON.parse(localStorage.getItem(storageKey) || '[]');

            // Add new message
            roomMessages.push(message);

            // Keep only last 100 messages
            if (roomMessages.length > 100) {
                roomMessages = roomMessages.slice(-100);
            }

            localStorage.setItem(storageKey, JSON.stringify(roomMessages));
        }

        function loadMessagesFromLocalStorage() {
            const storageKey = `chatapp_room_${roomId}`;
            const roomMessages = JSON.parse(localStorage.getItem(storageKey) || '[]');

            // Clear current messages
            messages = [];

            // Load messages from storage
            roomMessages.forEach(msg => {
                messages.push({
                    id: msg.id,
                    user: msg.user,
                    text: msg.text,
                    timestamp: new Date(msg.timestamp),
                    type: msg.type
                });
            });

            // Sort by timestamp
            messages.sort((a, b) => a.timestamp - b.timestamp);
            renderMessages();
            scrollToBottom();
        }

        function triggerSyncEvent(message) {
            // Use localStorage event to sync across tabs
            const syncData = {
                type: 'new_message',
                roomId: roomId,
                message: message,
                timestamp: Date.now()
            };

            localStorage.setItem('chatapp_sync_event', JSON.stringify(syncData));

            // Remove sync event after short delay
            setTimeout(() => {
                localStorage.removeItem('chatapp_sync_event');
            }, 1000);
        }

        // Listen for sync events from other tabs
        window.addEventListener('storage', function(e) {
            if (e.key === 'chatapp_sync_event' && e.newValue) {
                try {
                    const syncData = JSON.parse(e.newValue);

                    if (syncData.type === 'new_message' && syncData.roomId === roomId) {
                        // Check if message already exists
                        const existingMessage = messages.find(msg => msg.id === syncData.message.id);

                        if (!existingMessage) {
                            // Add message from other tab
                            const msg = syncData.message;
                            messages.push({
                                id: msg.id,
                                user: msg.user,
                                text: msg.text,
                                timestamp: new Date(msg.timestamp),
                                type: msg.type
                            });

                            // Sort and render
                            messages.sort((a, b) => a.timestamp - b.timestamp);
                            renderMessages();
                            scrollToBottom();

                            console.log('📨 Received synced message from other tab');
                        }
                    }
                } catch (error) {
                    console.error('Error processing sync event:', error);
                }
            }
        });

        function sendCallNotification(targetUser, callType) {
            if (!window.firebaseDatabase) return;

            const callsRef = window.firebaseRef(window.firebaseDatabase, `rooms/${roomId}/calls`);
            window.firebasePush(callsRef, {
                caller: userName,
                target: targetUser,
                type: callType,
                timestamp: Date.now()
            });
        }

        // WebRTC signaling functions
        function sendWebRTCSignal(target, type, data) {
            if (!window.firebaseDatabase) return;

            const signalingRef = window.firebaseRef(window.firebaseDatabase, `rooms/${roomId}/webrtc`);
            window.firebasePush(signalingRef, {
                sender: userName,
                target: target,
                type: type,
                data: data,
                timestamp: Date.now()
            });
        }

        async function handleWebRTCSignal(signal) {
            console.log('📡 Received WebRTC signal:', signal.type);

            switch (signal.type) {
                case 'offer':
                    await handleOffer(signal.data, signal.sender);
                    break;
                case 'answer':
                    await handleAnswer(signal.data);
                    break;
                case 'ice-candidate':
                    await handleIceCandidate(signal.data);
                    break;
                case 'call-end':
                    handleCallEnd();
                    break;
                case 'call-rejected':
                    handleCallRejected();
                    break;
            }
        }

        async function createPeerConnection() {
            peerConnection = new RTCPeerConnection(rtcConfiguration);

            // Handle ICE candidates
            peerConnection.onicecandidate = (event) => {
                if (event.candidate && currentCallId) {
                    sendWebRTCSignal(currentCallId, 'ice-candidate', event.candidate);
                }
            };

            // Handle remote stream
            peerConnection.ontrack = (event) => {
                console.log('📹 Received remote stream');
                remoteStream = event.streams[0];

                if (isVideoCall) {
                    document.getElementById('remoteVideo').srcObject = remoteStream;
                } else {
                    // For audio calls, we still need to handle the stream
                    const audioElement = document.createElement('audio');
                    audioElement.srcObject = remoteStream;
                    audioElement.autoplay = true;
                    document.body.appendChild(audioElement);
                }
            };

            // Add local stream to peer connection
            if (localStream) {
                localStream.getTracks().forEach(track => {
                    peerConnection.addTrack(track, localStream);
                });
            }

            return peerConnection;
        }

        // Initialize page
        function initializePage() {
            // Set room ID display
            document.getElementById('roomIdDisplay').textContent = roomId;

            // Initialize user count
            updateUserCount();

            // Load existing messages from localStorage
            loadMessagesFromLocalStorage();

            // Add welcome message (only if no messages exist)
            setTimeout(() => {
                if (messages.length === 0) {
                    sendMessageToFirebase('النظام', `مرحباً ${userName}! انضممت للغرفة ${roomId}`, 'system');
                }
            }, 1000);

            console.log('✅ Page initialized successfully');
            console.log('Room ID:', roomId);
            console.log('User Name:', userName);
            console.log('User Info:', currentUserInfo);
            console.log('📨 Local sync enabled for cross-tab messaging');
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', initializePage);

        // Fallback initialization
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializePage);
        } else {
            initializePage();
        }

        function addMessage(user, text, type = 'text') {
            const message = {
                id: Date.now(),
                user: user,
                text: text,
                timestamp: new Date(),
                type: type
            };
            
            messages.push(message);
            renderMessages();
            scrollToBottom();
        }

        function renderMessages() {
            const messagesContainer = document.getElementById('messages');
            messagesContainer.innerHTML = '';
            
            messages.forEach(message => {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${message.user === userName ? 'own' : ''}`;
                
                const bubbleDiv = document.createElement('div');
                bubbleDiv.className = `message-bubble ${
                    message.type === 'system' ? 'system' : 
                    message.user === userName ? 'own' : 'other'
                }`;
                
                let content = '';
                if (message.type !== 'system') {
                    content += `<div class="message-user">${message.user}</div>`;
                }
                content += `<div>${message.text}</div>`;
                content += `<div class="message-time">${message.timestamp.toLocaleTimeString('ar-SA')}</div>`;
                
                bubbleDiv.innerHTML = content;
                messageDiv.appendChild(bubbleDiv);
                messagesContainer.appendChild(messageDiv);
            });
        }

        function scrollToBottom() {
            const messagesContainer = document.getElementById('messages');
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // WebRTC signal handlers
        async function handleOffer(offer, sender) {
            console.log('📞 Handling incoming call offer from:', sender);

            currentCallId = sender;
            isCallInitiator = false;
            callState = 'ringing';

            // Show incoming call notification
            showCallNotification(sender, offer.type || 'video');

            // Store the offer for when user accepts
            incomingCall = { caller: sender, offer: offer, type: offer.type || 'video' };
        }

        async function handleAnswer(answer) {
            console.log('✅ Received call answer');

            if (peerConnection) {
                await peerConnection.setRemoteDescription(answer);
                callState = 'connected';
                sendMessageToFirebase('النظام', `تم الاتصال مع ${currentCallId}`, 'system');
            }
        }

        async function handleIceCandidate(candidate) {
            console.log('🧊 Received ICE candidate');

            if (peerConnection) {
                await peerConnection.addIceCandidate(candidate);
            }
        }

        function handleCallEnd() {
            console.log('📞 Call ended by remote user');
            endCall();
            sendMessageToFirebase('النظام', `انتهت المكالمة مع ${currentCallId}`, 'system');
        }

        function handleCallRejected() {
            console.log('❌ Call rejected by remote user');
            endCall();
            sendMessageToFirebase('النظام', `${currentCallId} رفض المكالمة`, 'system');
        }

        function sendMessage() {
            const input = document.getElementById('messageInput');
            const text = input.value.trim();

            if (text) {
                // Stop typing indicator
                if (isTyping) {
                    isTyping = false;
                    setTypingStatus(false);
                    if (typingTimeout) {
                        clearTimeout(typingTimeout);
                        typingTimeout = null;
                    }
                }

                // Send to Firebase for real-time sync
                sendMessageToFirebase(userName, text);
                input.value = '';
            }
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        // Typing indicator functions
        let typingTimeout = null;
        let isTyping = false;

        function handleTyping() {
            if (!firebaseConnected) return;

            // Start typing indicator
            if (!isTyping) {
                isTyping = true;
                setTypingStatus(true);
            }

            // Clear previous timeout
            if (typingTimeout) {
                clearTimeout(typingTimeout);
            }

            // Stop typing after 2 seconds of inactivity
            typingTimeout = setTimeout(() => {
                isTyping = false;
                setTypingStatus(false);
            }, 2000);
        }

        function setTypingStatus(typing) {
            if (!window.firebaseDatabase) return;

            const typingRef = window.firebaseRef(window.firebaseDatabase, `rooms/${roomId}/typing/${userName}`);
            if (typing) {
                window.firebaseSet(typingRef, true);
            } else {
                window.firebaseSet(typingRef, null);
            }
        }

        function showTypingIndicator(typingUsers) {
            const indicator = document.getElementById('typingIndicator');
            const text = document.getElementById('typingText');

            if (typingUsers.length > 0) {
                let message = '';
                if (typingUsers.length === 1) {
                    message = `${typingUsers[0]} يكتب...`;
                } else if (typingUsers.length === 2) {
                    message = `${typingUsers[0]} و ${typingUsers[1]} يكتبان...`;
                } else {
                    message = `${typingUsers.length} أشخاص يكتبون...`;
                }

                text.textContent = message;
                indicator.style.display = 'block';
                scrollToBottom();
            } else {
                hideTypingIndicator();
            }
        }

        function hideTypingIndicator() {
            const indicator = document.getElementById('typingIndicator');
            indicator.style.display = 'none';
        }

        // Call notification functions
        function showCallNotification(callerName, callType) {
            document.getElementById('callerName').textContent = `من: ${callerName}`;
            document.getElementById('callType').textContent = callType === 'video' ? '📹 مكالمة مرئية' : '📞 مكالمة صوتية';
            document.getElementById('callOverlay').classList.remove('hidden');
            document.getElementById('callNotification').classList.remove('hidden');

            // Play call sound
            playCallSound();

            // Store incoming call info
            incomingCall = { caller: callerName, type: callType };
        }

        function hideCallNotification() {
            document.getElementById('callOverlay').classList.add('hidden');
            document.getElementById('callNotification').classList.add('hidden');
            stopCallSound();
            incomingCall = null;
        }

        function playCallSound() {
            // Create audio context for call sound
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);

                oscillator.start();
                oscillator.stop(audioContext.currentTime + 0.5);

                // Repeat every 2 seconds
                callSound = setInterval(() => {
                    if (incomingCall) {
                        const newOscillator = audioContext.createOscillator();
                        const newGainNode = audioContext.createGain();

                        newOscillator.connect(newGainNode);
                        newGainNode.connect(audioContext.destination);

                        newOscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                        newGainNode.gain.setValueAtTime(0.3, audioContext.currentTime);

                        newOscillator.start();
                        newOscillator.stop(audioContext.currentTime + 0.5);
                    }
                }, 2000);
            } catch (error) {
                console.log('Could not play call sound:', error);
            }
        }

        function stopCallSound() {
            if (callSound) {
                clearInterval(callSound);
                callSound = null;
            }
        }

        // Message notification sound
        function playMessageSound() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                // Different tone for messages (higher pitch, shorter)
                oscillator.frequency.setValueAtTime(1000, audioContext.currentTime);
                gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);

                oscillator.start();
                oscillator.stop(audioContext.currentTime + 0.2);
            } catch (error) {
                console.log('Could not play message sound:', error);
            }
        }

        function acceptCall() {
            if (!incomingCall) return;

            hideCallNotification();

            if (incomingCall.type === 'video') {
                startVideoCall(true); // true means accepting incoming call
            } else {
                startAudioCall(true); // true means accepting incoming call
            }

            sendMessageToFirebase('النظام', `${userName} قبل مكالمة من ${incomingCall.caller}`, 'system');

            // Clear incoming call
            incomingCall = null;
        }

        function rejectCall() {
            if (!incomingCall) return;

            hideCallNotification();
            sendMessageToFirebase('النظام', `${userName} رفض مكالمة من ${incomingCall.caller}`, 'system');

            // Send rejection signal if using WebRTC
            if (firebaseConnected && incomingCall.caller) {
                sendWebRTCSignal(incomingCall.caller, 'call-rejected', {});
            }

            incomingCall = null;
        }



        async function startVideoCall(isAccepting = false) {
            try {
                console.log('🎥 Starting video call...');

                localStream = await navigator.mediaDevices.getUserMedia({
                    video: true,
                    audio: true
                });

                document.getElementById('localVideo').srcObject = localStream;
                document.getElementById('videoArea').classList.add('active');
                document.getElementById('callControls').style.display = 'none';
                document.getElementById('audioCallDisplay').style.display = 'none';

                isVideoCall = true;
                isAudioCall = false;
                callState = isAccepting ? 'connected' : 'calling';

                if (!isAccepting) {
                    // Initiating a new call
                    if (firebaseConnected && connectedUsers.length > 1) {
                        // Call the first other user in the room
                        const otherUsers = connectedUsers.filter(user => user !== userName);
                        if (otherUsers.length > 0) {
                            currentCallId = otherUsers[0];
                            isCallInitiator = true;

                            // Create peer connection and send offer
                            await createPeerConnection();
                            const offer = await peerConnection.createOffer();
                            await peerConnection.setLocalDescription(offer);

                            // Send offer via Firebase
                            sendWebRTCSignal(currentCallId, 'offer', { ...offer, type: 'video' });

                            sendMessageToFirebase('النظام', `${userName} بدأ مكالمة مرئية مع ${currentCallId}`, 'system');
                        } else {
                            alert('لا يوجد مستخدمون آخرون في الغرفة');
                            endCall();
                            return;
                        }
                    } else {
                        // Fallback for local mode
                        sendMessageToFirebase('النظام', `${userName} بدأ مكالمة مرئية`, 'system');
                        notifyAllUsersOfCall('video');
                    }
                } else {
                    // Accepting an incoming call
                    if (firebaseConnected && incomingCall) {
                        await createPeerConnection();
                        await peerConnection.setRemoteDescription(incomingCall.offer);

                        const answer = await peerConnection.createAnswer();
                        await peerConnection.setLocalDescription(answer);

                        // Send answer back
                        sendWebRTCSignal(incomingCall.caller, 'answer', answer);

                        sendMessageToFirebase('النظام', `${userName} قبل المكالمة المرئية`, 'system');
                    }
                }

                console.log('✅ Video call setup complete');
            } catch (error) {
                console.error('❌ Error starting video call:', error);
                alert('لا يمكن الوصول للكاميرا والميكروفون');
                endCall();
            }
        }

        async function startAudioCall(isAccepting = false) {
            try {
                console.log('🎤 Starting audio call...');

                localStream = await navigator.mediaDevices.getUserMedia({
                    video: false,
                    audio: true
                });

                document.getElementById('videoArea').classList.add('active');
                document.getElementById('callControls').style.display = 'none';
                document.getElementById('audioCallDisplay').style.display = 'flex';

                isAudioCall = true;
                isVideoCall = false;
                callState = isAccepting ? 'connected' : 'calling';

                if (!isAccepting) {
                    // Initiating a new call
                    if (firebaseConnected && connectedUsers.length > 1) {
                        // Call the first other user in the room
                        const otherUsers = connectedUsers.filter(user => user !== userName);
                        if (otherUsers.length > 0) {
                            currentCallId = otherUsers[0];
                            isCallInitiator = true;

                            // Create peer connection and send offer
                            await createPeerConnection();
                            const offer = await peerConnection.createOffer();
                            await peerConnection.setLocalDescription(offer);

                            // Send offer via Firebase
                            sendWebRTCSignal(currentCallId, 'offer', { ...offer, type: 'audio' });

                            sendMessageToFirebase('النظام', `${userName} بدأ مكالمة صوتية مع ${currentCallId}`, 'system');
                        } else {
                            alert('لا يوجد مستخدمون آخرون في الغرفة');
                            endCall();
                            return;
                        }
                    } else {
                        // Fallback for local mode
                        sendMessageToFirebase('النظام', `${userName} بدأ مكالمة صوتية`, 'system');
                        notifyAllUsersOfCall('audio');
                    }
                } else {
                    // Accepting an incoming call
                    if (firebaseConnected && incomingCall) {
                        await createPeerConnection();
                        await peerConnection.setRemoteDescription(incomingCall.offer);

                        const answer = await peerConnection.createAnswer();
                        await peerConnection.setLocalDescription(answer);

                        // Send answer back
                        sendWebRTCSignal(incomingCall.caller, 'answer', answer);

                        sendMessageToFirebase('النظام', `${userName} قبل المكالمة الصوتية`, 'system');
                    }
                }

                console.log('✅ Audio call setup complete');
            } catch (error) {
                console.error('❌ Error starting audio call:', error);
                alert('لا يمكن الوصول للميكروفون');
                endCall();
            }
        }

        function notifyAllUsersOfCall(callType) {
            // Send call notification to all connected users except self
            connectedUsers.forEach(user => {
                if (user !== userName) {
                    sendCallNotification(user, callType);
                }
            });
        }

        // Add test button for incoming calls (for demo)
        function testIncomingCall() {
            if (!incomingCall) {
                showCallNotification('مستخدم تجريبي', 'video');
            }
        }

        function endCall() {
            console.log('📞 Ending call...');

            // Stop local stream
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }

            // Stop remote stream
            if (remoteStream) {
                remoteStream.getTracks().forEach(track => track.stop());
                remoteStream = null;
            }

            // Close peer connection
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }

            // Send call end signal to other user
            if (firebaseConnected && currentCallId && callState !== 'idle') {
                sendWebRTCSignal(currentCallId, 'call-end', {});
            }

            // Reset UI
            document.getElementById('videoArea').classList.remove('active');
            document.getElementById('callControls').style.display = 'flex';

            // Clear remote video
            const remoteVideo = document.getElementById('remoteVideo');
            if (remoteVideo) {
                remoteVideo.srcObject = null;
            }

            // Reset call state
            isVideoCall = false;
            isAudioCall = false;
            callState = 'idle';
            currentCallId = null;
            isCallInitiator = false;

            sendMessageToFirebase('النظام', `${userName} أنهى المكالمة`, 'system');

            console.log('✅ Call ended successfully');
        }

        // Media control functions
        function toggleMute() {
            if (localStream) {
                const audioTrack = localStream.getAudioTracks()[0];
                if (audioTrack) {
                    audioTrack.enabled = !audioTrack.enabled;
                    const muteBtn = document.getElementById('muteBtn');
                    if (muteBtn) {
                        muteBtn.textContent = audioTrack.enabled ? '🔇 كتم الصوت' : '🔊 تشغيل الصوت';
                        muteBtn.style.background = audioTrack.enabled ? '#6b7280' : '#dc3545';
                    }

                    sendMessageToFirebase('النظام', `${userName} ${audioTrack.enabled ? 'شغل' : 'كتم'} الصوت`, 'system');
                }
            }
        }

        function toggleVideo() {
            if (localStream) {
                const videoTrack = localStream.getVideoTracks()[0];
                if (videoTrack) {
                    videoTrack.enabled = !videoTrack.enabled;
                    const videoBtn = document.getElementById('videoBtn');
                    if (videoBtn) {
                        videoBtn.textContent = videoTrack.enabled ? '📹 إيقاف الفيديو' : '📷 تشغيل الفيديو';
                        videoBtn.style.background = videoTrack.enabled ? '#6b7280' : '#dc3545';
                    }

                    sendMessageToFirebase('النظام', `${userName} ${videoTrack.enabled ? 'شغل' : 'أوقف'} الفيديو`, 'system');
                }
            }
        }

        function copyRoomLink() {
            // Get the correct base URL for GitHub Pages
            const baseUrl = window.location.origin + window.location.pathname.replace('/room.html', '');
            const link = `${baseUrl}/room.html?roomId=${roomId}`;

            navigator.clipboard.writeText(link).then(() => {
                alert('✅ تم نسخ رابط الغرفة!\n\n' + link + '\n\nيمكنك الآن إرساله لأصدقائك');
            }).catch(() => {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = link;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert('✅ تم نسخ رابط الغرفة!\n\n' + link + '\n\nيمكنك الآن إرساله لأصدقائك');
            });
        }

        function shareRoom() {
            // Get the correct base URL for GitHub Pages
            const baseUrl = window.location.origin + window.location.pathname.replace('/room.html', '');
            const link = `${baseUrl}/room.html?roomId=${roomId}`;
            const shareText = `🎉 انضم إلي في ChatApp!\n\nغرفة: ${roomId}\nالرابط: ${link}\n\n💬 مراسلة فورية + مكالمات صوتية ومرئية`;

            // Try native sharing first (mobile)
            if (navigator.share) {
                navigator.share({
                    title: 'ChatApp - انضم للمحادثة',
                    text: shareText,
                    url: link
                }).catch(() => {
                    // Fallback to copy
                    copyToClipboard(shareText);
                });
            } else {
                // Desktop fallback
                copyToClipboard(shareText);
            }
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert('📤 تم نسخ رسالة المشاركة!\n\nيمكنك الآن لصقها في WhatsApp أو أي تطبيق آخر');
            }).catch(() => {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert('📤 تم نسخ رسالة المشاركة!\n\nيمكنك الآن لصقها في WhatsApp أو أي تطبيق آخر');
            });
        }

        // Redirect to home if no room ID
        if (!roomId) {
            window.location.href = 'index.html';
        }
    </script>
</body>
</html>
